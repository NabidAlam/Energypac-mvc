@model IEnumerable<AuditReport.Models.ProjectSitePlanTask>
@{
    ViewBag.Title = "ProjectSitePlanTaskInfo";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var counter = 1;
    AuditReport.Models.EPARSDbContext db = new AuditReport.Models.EPARSDbContext();
}


<style>
    input[type="text"] {
     border-top: 0;
     border-right: 0;
     border-left: 0;
     border-color:#e2e2e2;
     border-width:thin;
     -webkit-box-shadow: none;
     box-shadow: none;
}
</style>


    <div class="alert alert-primary text-center">
        <div class="well well-sm">
            <h5>Project Name: @Model.Where(x => x.ProjectId == Convert.ToInt32(Request["ProjectId"].ToString())).Select(y => y.Project.Name).FirstOrDefault()</h5>
            <h6>Site Name: @Model.Where(x => x.ProjectSiteId == Convert.ToInt32(Request["SiteId"].ToString())).Select(y => y.ProjectSite.Name).FirstOrDefault()</h6>
        </div>
        <h4>Project Status</h4>
        <div class="form-inline">
            <div class="form-group">
                <label>Plan Date</label>
                @Html.TextBox("PlanDate", null, new { @disabled = "disabled", @class = "form-control" })
            </div>
            <div class="form-group">
                <label>Plan Code</label>
                @Html.TextBox("PlanCode", null, new { @disabled = "disabled", @style = "width:80px;", @class = "form-control" })
            </div>

            <div class="form-group">
                <label>Status Date</label>
                @Html.TextBox("StatusDate", null, new { @class = "form-control" })
            </div>
            <input type="button" class="btn btn-xs btn-primary" value="Save" id="saveState" />
            @Html.Hidden("ProjectId")
            @Html.Hidden("SiteId")
        </div>
    </div>



<div class="table-responsive">
    <table class="table table-bordered table-sm StatusTable">
        @*<tr>
            <td>Plan Date</td>
            <td>@Html.TextBox("PlanDate", null, new { @disabled="disabled"})</td>
            <td>Plan Code</td>
            <td>@Html.TextBox("PlanCode", null, new { @disabled = "disabled", @style = "width:80px;" })</td>
            <td colspan="3">
                <input type="button" class="btn-primary" value="Save" id="saveState" />
                @Html.Hidden("ProjectId")
                @Html.Hidden("SiteId")
            </td>
            <td>Status Date</td>
            <td>@Html.TextBox("StatusDate", null)</td>
        </tr>*@
        <tr class="bg-blue">
            <th>Id</th>
            <th style="min-width:400px;">Task Name</th>
            <th>WBS</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Previous Status</th>
            <th>Percent(%) Comp</th>
            <th>Present Status</th>
            <th>Actual Compression Date</th>
            <th>Deviation</th>
            <th>Reason for Deviation</th>
            <th>Remarks</th>
        </tr>
@foreach (var item in Model)
{
    var TaskName = db.ProjectTask.Where(x => x.Id == item.ProjectTaskId).Select(y => y.Name).FirstOrDefault();
    
    <tr>
        <td>@counter</td>
        @if (item.MileStone != null)
        {
            if (item.ControlId != 0)
            {
                <td style="color:green;"><p style="margin-left:20px;">@TaskName </p> @Html.Hidden("TID", @item.ProjectTaskId, new { @name = "TID" })</td>
            }
            else
            {
                <td style="color:green;font-weight:bold;">@TaskName @Html.Hidden("TID", @item.ProjectTaskId, new { @name = "TID" })</td>
            }

        }
        else
        {
            if (item.ControlId != 0)
            {
                <td> <p style="margin-left:20px;">@TaskName </p> @Html.Hidden("TID", @item.ProjectTaskId, new { @name = "TID" })</td>
            }
            else
            {
                <td style="font-weight:bold;">@TaskName @Html.Hidden("TID", @item.ProjectTaskId, new { @name = "TID" })</td>
            }
           
        }
        
        <td>@item.WBSCode @Html.Hidden("WBS", @item.WBSCode, new { @name = "WBS" })</td>
        <td>@item.StartDate.Value.ToShortDateString() @Html.Hidden("StartDate", @item.StartDate.Value.ToShortDateString(), new { @name = "StartDate" })</td>
        <td>@item.EndDate.Value.ToShortDateString() @Html.Hidden("EndDate", @item.EndDate.Value.ToShortDateString(), new { @name = "EndDate" })</td>
        <td>@Html.Hidden("PrevStatus")</td>
        <td>@Html.TextBox("PerComp", null, new { @style = "width:30px;", @name = "PerComp" })</td>
        <td>@Html.TextBox("PresentStatus", null, new { @name = "PresentStatus", @style = "width:400px;" })</td>
        <td>@Html.TextBox("CompressionDate", null, new { @name = "CompressionDate", @style = "width:110px;" })</td>
        <td>@Html.TextBox("Deviation", null, new { @name = "Deviation" })</td>
        <td>@Html.TextBox("ResDeviation", null, new { @name = "ResDeviation" })</td>
        <td>@Html.TextBox("Remarks", null, new { @name = "Remarks" })</td>
    </tr>
    counter++;
}
     
    </table>
</div>





<p><button type="button" class="btn btn-warning btn-sm" onclick="window.location.href='@Url.Action("Index")';"><i class="icon-circle-left2 position-left"></i> Go back</button></p>





<script>
    //



    $('#saveState').click(function (e) {
        var PlanCode = $('#PlanCode').val();
        var PlanDate = $('#PlanDate').val();
        var ProjectId = $('#ProjectId').val();
        var SiteId = $('#SiteId').val();
        var StatusDate = $('#StatusDate').val();


        var TaskId = document.getElementsByName("TID");
        var WBS = document.getElementsByName("WBS");
        var StartDate = document.getElementsByName("StartDate");
        var EndDate = document.getElementsByName("EndDate");
        var Remarks = document.getElementsByName("Remarks");
        var PerComp = document.getElementsByName("PerComp");
        var PresentStatus = document.getElementsByName("PresentStatus");
        var Deviation = document.getElementsByName("Deviation");
        var ResDeviation = document.getElementsByName("ResDeviation");
        var CompressionDate = document.getElementsByName("CompressionDate");


        var Tasks = [];


        for (var i = 0; i < TaskId.length; i++) {


            Tasks.push({ TaskId: TaskId[i].value, WBS: WBS[i].value, StartDate: StartDate[i].value, EndDate: EndDate[i].value, Remarks: Remarks[i].value, PerComp: PerComp[i].value, PresentStatus: PresentStatus[i].value, Deviation: Deviation[i].value, ResDeviation: ResDeviation[i].value , CompressionDate:CompressionDate[i].value});


        }
        console.log(Tasks);
        TaskDetails = JSON.stringify({ TaskDetails: Tasks, ProjectId: ProjectId, SiteId: SiteId, PlanDate: PlanDate, PlanCode: PlanCode, StatusDate: StatusDate });

        $.ajax({
            contentType: 'application/json; charset=utf-8',
            dataType: 'json',
            type: 'POST',
            url: '/ProjectSitePlanTasks/SavePlanTaskStatus',
            data: TaskDetails,
            success: function (result) {
                console.log(result);
                if (result) {
                    alert("Record save successfully!");
                }
                else {
                    alert("Plancode or date already exists !");
                }

            },
            failure: function (response) {

            }
        });

    });
</script>